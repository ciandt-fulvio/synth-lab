#!/bin/bash
#
# Claude Code Hook: pre-commit
#
# Este hook √© executado ANTES de um commit e instrui o Claude a verificar
# se os testes foram atualizados para cobrir as mudan√ßas.
#
# Documenta√ß√£o: https://docs.anthropic.com/claude/docs/claude-code-hooks

set -e

# Lista arquivos staged (que ser√£o commitados)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Se n√£o h√° arquivos staged, sai
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Filtra apenas arquivos de c√≥digo (ignora testes)
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(py|ts|tsx|js|jsx)$' | grep -v -E 'test|spec|__tests__|\.test\.|\.spec\.' || true)

# Se n√£o h√° arquivos de c√≥digo, n√£o precisa verificar testes
if [ -z "$CODE_FILES" ]; then
    exit 0
fi

# Detecta tipos de mudan√ßas
HAS_BACKEND=$(echo "$CODE_FILES" | grep -E '^src/synth_lab/.*\.py$' || true)
HAS_FRONTEND=$(echo "$CODE_FILES" | grep -E '^frontend/src/.*\.(ts|tsx|js|jsx)$' || true)

# Se apenas arquivos de teste foram modificados, n√£o mostra prompt
TEST_FILES=$(echo "$STAGED_FILES" | grep -E 'test|spec|__tests__|\.test\.|\.spec\.' || true)
if [ -n "$TEST_FILES" ] && [ -z "$CODE_FILES" ]; then
    exit 0
fi

# Monta o prompt para o Claude
cat <<EOF

üß™ **PRE-COMMIT TEST CHECK**

Voc√™ est√° prestes a commitar arquivos de c√≥digo.

**Arquivos de c√≥digo staged:**
$CODE_FILES

EOF

if [ -n "$TEST_FILES" ]; then
    cat <<EOF
**Arquivos de teste staged:**
$TEST_FILES

EOF
fi

cat <<EOF
**VERIFICA√á√ÉO OBRIGAT√ìRIA:**

Antes de commitar, confirme que:

EOF

if [ -n "$HAS_BACKEND" ]; then
    cat <<EOF
### Backend (Python)
- [ ] Testes unit√°rios criados/atualizados para novas fun√ß√µes
- [ ] Testes de integra√ß√£o se houver intera√ß√£o entre componentes
- [ ] Testes de repository se houver queries SQL novas/modificadas
- [ ] Testes de servi√ßo se houver l√≥gica de neg√≥cio nova/modificada
- [ ] Testes de API se endpoints foram criados/modificados

**Comandos:**
\`\`\`bash
# Rodar testes unit√°rios
pytest tests/unit/

# Rodar testes de integra√ß√£o
pytest tests/integration/

# Rodar todos os testes
pytest tests/
\`\`\`

EOF
fi

if [ -n "$HAS_FRONTEND" ]; then
    cat <<EOF
### Frontend (TypeScript/React)
- [ ] Testes unit√°rios para componentes novos/modificados
- [ ] Testes de hooks se houver custom hooks
- [ ] Testes de servi√ßos/utils se houver l√≥gica modificada
- [ ] Testes E2E atualizados se fluxos de UI foram modificados

**Comandos:**
\`\`\`bash
cd frontend

# Testes unit√°rios
npm test

# Testes E2E (Playwright)
npm run test:e2e

# Coverage
npm run test:coverage
\`\`\`

EOF
fi

cat <<EOF
**PADR√ïES DE TESTE A SEGUIR:**

1. **Cobertura M√≠nima:**
   - Fun√ß√µes p√∫blicas: 100%
   - L√≥gica de neg√≥cio: 100%
   - Components: 80%+
   - Edge cases: Obrigat√≥rio

2. **Estrutura de Teste:**
   - Backend: Seguir padr√£o em \`tests/\` espelhando \`src/\`
   - Frontend: Seguir padr√£o \`*.test.ts\` ou \`*.spec.ts\`

3. **Tipos de Teste:**
   - **Unit**: Fun√ß√µes isoladas, sem depend√™ncias externas
   - **Integration**: Intera√ß√£o entre componentes/servi√ßos
   - **Contract**: APIs/endpoints (request/response)
   - **E2E**: Fluxos completos de usu√°rio

4. **Valida√ß√£o:**
   - ‚úÖ Casos de sucesso
   - ‚úÖ Casos de erro
   - ‚úÖ Edge cases
   - ‚úÖ Valida√ß√£o de inputs
   - ‚úÖ Tratamento de exce√ß√µes

**A√á√ÉO REQUERIDA:**

Execute os comandos acima e confirme:
1. Quais testes foram criados/atualizados?
2. Qual a cobertura atual?
3. Todos os testes passaram?

**IMPORTANTE:** Se voc√™ n√£o criou/atualizou testes, fa√ßa isso AGORA antes do commit.

EOF

# Retorna 0 para n√£o bloquear o commit, mas o prompt ser√° mostrado
exit 0
