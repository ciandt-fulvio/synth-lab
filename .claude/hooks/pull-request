#!/bin/bash
#
# Claude Code Hook: pull-request
#
# Este hook √© executado quando voc√™ pede ao Claude para criar um PR.
# Ele verifica se os testes foram atualizados e adiciona checklist ao PR.
#
# Documenta√ß√£o: https://docs.anthropic.com/claude/docs/claude-code-hooks

set -e

# Pega a branch atual e a branch base (main/master)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
BASE_BRANCH=${1:-main}

# Se n√£o conseguir determinar base branch, tenta master
if ! git rev-parse --verify "origin/$BASE_BRANCH" >/dev/null 2>&1; then
    BASE_BRANCH="master"
fi

# Lista todos os arquivos modificados neste branch comparado com base
if git rev-parse --verify "origin/$BASE_BRANCH" >/dev/null 2>&1; then
    CHANGED_FILES=$(git diff --name-only "origin/$BASE_BRANCH...HEAD")
    COMMITS=$(git log --oneline "origin/$BASE_BRANCH..HEAD")
else
    CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
    COMMITS=$(git log --oneline -1)
fi

# Filtra arquivos de c√≥digo e testes separadamente
CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(py|ts|tsx|js|jsx)$' | grep -v -E 'test|spec|__tests__|\.test\.|\.spec\.' || true)
TEST_FILES=$(echo "$CHANGED_FILES" | grep -E 'test|spec|__tests__|\.test\.|\.spec\.' || true)

# Detecta tipos de mudan√ßas
HAS_BACKEND=$(echo "$CODE_FILES" | grep -E '^src/synth_lab/.*\.py$' || true)
HAS_FRONTEND=$(echo "$CODE_FILES" | grep -E '^frontend/src/.*\.(ts|tsx|js|jsx)$' || true)
HAS_API=$(echo "$CODE_FILES" | grep -E '^src/synth_lab/api/.*\.py$' || true)
HAS_SERVICE=$(echo "$CODE_FILES" | grep -E '^src/synth_lab/services/.*\.py$' || true)
HAS_COMPONENT=$(echo "$CODE_FILES" | grep -E '^frontend/src/components/.*\.(tsx|jsx)$' || true)
HAS_PAGE=$(echo "$CODE_FILES" | grep -E '^frontend/src/pages/.*\.(tsx|jsx)$' || true)

# Detecta tipos de testes modificados
HAS_UNIT_TESTS=$(echo "$TEST_FILES" | grep -E 'tests/unit/|\.test\.(ts|tsx|py)$' || true)
HAS_INTEGRATION_TESTS=$(echo "$TEST_FILES" | grep -E 'tests/integration/' || true)
HAS_E2E_TESTS=$(echo "$TEST_FILES" | grep -E 'tests/e2e/|\.spec\.ts$' || true)

# Monta o prompt para o Claude
cat <<EOF

üîç **PULL REQUEST TEST VALIDATION**

Voc√™ est√° criando um Pull Request de **$CURRENT_BRANCH** para **$BASE_BRANCH**.

**üìä An√°lise de Mudan√ßas:**

**Commits inclu√≠dos:**
$COMMITS

**Arquivos de c√≥digo modificados:** $(echo "$CODE_FILES" | wc -l | tr -d ' ')
$CODE_FILES

**Arquivos de teste modificados:** $(echo "$TEST_FILES" | wc -l | tr -d ' ')
$TEST_FILES

---

**üß™ VERIFICA√á√ÉO DE TESTES - OBRIGAT√ìRIO**

Antes de criar o PR, voc√™ DEVE garantir que:

EOF

# Se√ß√£o de Backend
if [ -n "$HAS_BACKEND" ]; then
    cat <<EOF
### ‚úÖ Backend (Python) - Testes Obrigat√≥rios

EOF

    if [ -n "$HAS_API" ]; then
        cat <<EOF
**APIs Modificadas** (\`api/\`):
- [ ] Testes de contrato para endpoints novos/modificados
- [ ] Testes de valida√ß√£o de request/response
- [ ] Testes de status codes (200, 400, 404, 500)
- [ ] Testes de autentica√ß√£o/autoriza√ß√£o (se aplic√°vel)

EOF
    fi

    if [ -n "$HAS_SERVICE" ]; then
        cat <<EOF
**Servi√ßos Modificados** (\`services/\`):
- [ ] Testes unit√°rios para l√≥gica de neg√≥cio
- [ ] Testes de integra√ß√£o com repositories
- [ ] Testes de integra√ß√£o com LLM calls (mocked)
- [ ] Testes de error handling

EOF
    fi

    cat <<EOF
**Comandos para validar:**
\`\`\`bash
# Testes unit√°rios
pytest tests/unit/ -v

# Testes de integra√ß√£o
pytest tests/integration/ -v

# Coverage
pytest --cov=src/synth_lab --cov-report=term-missing

# Smoke tests
pytest tests/smoke/ -v
\`\`\`

EOF
fi

# Se√ß√£o de Frontend
if [ -n "$HAS_FRONTEND" ]; then
    cat <<EOF
### ‚úÖ Frontend (TypeScript/React) - Testes Obrigat√≥rios

EOF

    if [ -n "$HAS_COMPONENT" ]; then
        cat <<EOF
**Componentes Modificados** (\`components/\`):
- [ ] Testes unit√°rios para rendering
- [ ] Testes de intera√ß√£o (clicks, inputs)
- [ ] Testes de props
- [ ] Testes de conditional rendering

EOF
    fi

    if [ -n "$HAS_PAGE" ]; then
        cat <<EOF
**P√°ginas Modificadas** (\`pages/\`):
- [ ] Testes de integra√ß√£o de p√°gina
- [ ] Testes E2E para fluxos principais
- [ ] Testes de navega√ß√£o
- [ ] Testes de loading states

EOF
    fi

    cat <<EOF
**Comandos para validar:**
\`\`\`bash
cd frontend

# Testes unit√°rios
npm test

# Testes E2E
npm run test:e2e

# Coverage
npm run test:coverage

# Lint
npm run lint
\`\`\`

EOF
fi

# An√°lise de cobertura de testes
cat <<EOF
---

**üìà CHECKLIST DE COBERTURA:**

EOF

if [ -n "$CODE_FILES" ] && [ -z "$TEST_FILES" ]; then
    cat <<EOF
‚ö†Ô∏è  **ATEN√á√ÉO:** C√≥digo foi modificado mas NENHUM teste foi adicionado/atualizado!

EOF
fi

if [ -n "$HAS_UNIT_TESTS" ]; then
    cat <<EOF
‚úÖ Testes unit√°rios foram modificados
EOF
else
    cat <<EOF
‚ùå Nenhum teste unit√°rio foi adicionado/modificado
EOF
fi

if [ -n "$HAS_INTEGRATION_TESTS" ]; then
    cat <<EOF
‚úÖ Testes de integra√ß√£o foram modificados
EOF
else
    if [ -n "$HAS_SERVICE" ] || [ -n "$HAS_API" ]; then
        cat <<EOF
‚ö†Ô∏è  Testes de integra√ß√£o devem ser adicionados para services/APIs
EOF
    fi
fi

if [ -n "$HAS_E2E_TESTS" ]; then
    cat <<EOF
‚úÖ Testes E2E foram modificados
EOF
else
    if [ -n "$HAS_PAGE" ] || [ -n "$HAS_COMPONENT" ]; then
        cat <<EOF
‚ö†Ô∏è  Testes E2E devem ser considerados para UI changes
EOF
    fi
fi

cat <<EOF

---

**üìã CHECKLIST PARA PR DESCRIPTION:**

Adicione esta checklist √† descri√ß√£o do PR:

\`\`\`markdown
## Test Plan

### Testes Executados
- [ ] Unit tests: \`pytest tests/unit/\` ou \`npm test\`
- [ ] Integration tests: \`pytest tests/integration/\`
- [ ] E2E tests: \`npm run test:e2e\`
- [ ] Smoke tests: \`pytest tests/smoke/\`

### Cobertura de Testes
- [ ] Novos testes cobrem funcionalidades adicionadas
- [ ] Testes existentes foram atualizados se necess√°rio
- [ ] Edge cases foram considerados
- [ ] Error handling foi testado

### Valida√ß√£o Manual
- [ ] Testei localmente todos os fluxos afetados
- [ ] Verifiquei em diferentes resolu√ß√µes (se UI)
- [ ] Testei casos de erro

### Resultados
- **Test Coverage:** ____%
- **Tests Passing:** ___/___
- **E2E Tests Passing:** ___/___
\`\`\`

---

**üéØ A√á√ÉO REQUERIDA:**

1. **Execute TODOS os testes** relevantes listados acima
2. **Confirme que todos passam**
3. **Liste os testes criados/atualizados** neste PR
4. **Adicione a checklist** acima √† descri√ß√£o do PR
5. **Documente a cobertura** de testes alcan√ßada

**IMPORTANTE:**
- PRs sem testes adequados ser√£o rejeitados
- Cobertura m√≠nima: 80% para novo c√≥digo
- Todos os testes CI devem passar

**Voc√™ est√° pronto para criar o PR com testes completos?**

EOF

# Retorna 0 para n√£o bloquear a cria√ß√£o do PR
exit 0
