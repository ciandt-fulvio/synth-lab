#!/bin/bash
#
# Claude Code Hook: post-commit
#
# Este hook √© executado DEPOIS de um commit bem-sucedido.
# Ele lembra o Claude de executar os testes para validar o commit.
#
# Documenta√ß√£o: https://docs.anthropic.com/claude/docs/claude-code-hooks

set -e

# Pega informa√ß√µes do √∫ltimo commit
LAST_COMMIT=$(git log -1 --oneline)
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B)

# Lista arquivos modificados no √∫ltimo commit
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

# Filtra arquivos de c√≥digo
CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(py|ts|tsx|js|jsx)$' | grep -v -E 'test|spec|__tests__|\.test\.|\.spec\.' || true)

# Se n√£o h√° arquivos de c√≥digo, n√£o mostra prompt
if [ -z "$CODE_FILES" ]; then
    exit 0
fi

# Detecta tipo de mudan√ßa
HAS_BACKEND=$(echo "$CODE_FILES" | grep -E '^src/synth_lab/.*\.py$' || true)
HAS_FRONTEND=$(echo "$CODE_FILES" | grep -E '^frontend/src/.*\.(ts|tsx|js|jsx)$' || true)

cat <<EOF

‚úÖ **COMMIT SUCCESSFUL**

**Commit:** $COMMIT_HASH
**Message:** $COMMIT_MESSAGE

**üìÅ Arquivos de c√≥digo modificados:**
$CODE_FILES

---

**üß™ PR√ìXIMOS PASSOS - EXECUTAR TESTES**

Para garantir que o commit n√£o quebrou nada, execute:

EOF

if [ -n "$HAS_BACKEND" ]; then
    cat <<EOF
### Backend Tests
\`\`\`bash
# Quick check (unit tests)
pytest tests/unit/ -v

# Full check (all tests)
pytest tests/ -v

# With coverage
pytest --cov=src/synth_lab --cov-report=term-missing
\`\`\`

EOF
fi

if [ -n "$HAS_FRONTEND" ]; then
    cat <<EOF
### Frontend Tests
\`\`\`bash
cd frontend

# Unit tests
npm test

# E2E tests (if UI changed)
npm run test:e2e

# Lint check
npm run lint
\`\`\`

EOF
fi

cat <<EOF
---

**üí° RECOMENDA√á√ÉO:**

Execute os testes agora para:
1. Verificar que o commit n√£o introduziu bugs
2. Validar que a cobertura de testes est√° adequada
3. Garantir que testes existentes ainda passam

**Se algum teste falhar:**
- Corrija o problema
- Use \`git commit --amend\` para ajustar o commit
- Ou crie um novo commit com a corre√ß√£o

**Continue com:**
- \`git push\` quando os testes passarem
- Ou continue desenvolvendo se ainda h√° trabalho

EOF

exit 0
