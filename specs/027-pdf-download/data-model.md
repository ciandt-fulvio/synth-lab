# Data Model: PDF Download for Document Viewer

**Feature**: 027-pdf-download
**Date**: 2026-01-01
**Phase**: 1 - Design

## Overview

This feature is purely client-side and does not involve persistent data storage. The data model describes the component props, local state, and temporary data structures used during PDF generation.

## Component Props (DocumentViewer)

No changes to existing props. The component already receives all necessary data:

| Property | Type | Description | Validation |
|----------|------|-------------|------------|
| `isOpen` | `boolean` | Whether the dialog is open | Required |
| `onClose` | `() => void` | Callback when dialog is closed | Required |
| `documentType` | `DocumentType` | Document type for title and icon | Required, one of: 'prfaq', 'executive_summary', 'summary' |
| `markdownContent` | `string \| undefined` | Markdown content to display | Optional |
| `isLoading` | `boolean \| undefined` | Whether content is loading | Optional, default false |
| `status` | `DocumentStatus \| undefined` | Current document status | Optional, one of: 'pending', 'generating', 'completed', 'failed' |
| `errorMessage` | `string \| undefined` | Error message if failed | Optional |
| `titleSuffix` | `string \| undefined` | Optional custom title suffix | Optional, used for filename |

## Local State

New state variables to be added to DocumentViewer component:

| State Variable | Type | Initial Value | Purpose |
|----------------|------|---------------|---------|
| `isGeneratingPdf` | `boolean` | `false` | Tracks PDF generation in progress |
| `contentRef` | `RefObject<HTMLDivElement>` | `useRef(null)` | Reference to markdown content container for html2canvas |

## Temporary Data Structures

Data structures that exist only during PDF generation process:

### Canvas Object
```typescript
// Generated by html2canvas
interface HTMLCanvasElement {
  width: number;          // Canvas width in pixels
  height: number;         // Canvas height in pixels
  toDataURL: (type: string) => string;  // Convert to data URL
}
```

### jsPDF Instance
```typescript
// Generated by jsPDF constructor
interface jsPDF {
  addImage: (
    imageData: string,
    format: string,
    x: number,
    y: number,
    width: number,
    height: number
  ) => void;
  save: (filename: string) => void;
}
```

### PDF Generation Parameters
```typescript
interface PdfGenerationParams {
  scale: number;           // html2canvas scale factor (fixed: 2)
  orientation: 'portrait'; // PDF orientation (fixed)
  format: 'a4';           // PDF page format (fixed)
  unit: 'mm';             // Measurement unit (fixed)
}
```

## Derived Data

Data computed from existing props and state:

| Derived Value | Source | Computation | Usage |
|--------------|--------|-------------|-------|
| `filename` | `documentType`, `titleSuffix` | `${documentType}_${sanitize(titleSuffix)}.pdf` | PDF save filename |
| `isButtonDisabled` | `status`, `hasContent`, `isGeneratingPdf` | `isGenerating \|\| isFailed \|\| !hasContent \|\| isGeneratingPdf` | Button disabled state |
| `hasContent` | `markdownContent` | `markdownContent && markdownContent.length > 0` | Content availability check |
| `isGenerating` | `status`, `isLoading` | `status === 'generating' \|\| isLoading` | Document generation check |
| `isFailed` | `status` | `status === 'failed'` | Error state check |

## Filename Sanitization

Function to convert title suffix to valid filename:

```typescript
function sanitizeFilename(text: string | undefined): string {
  if (!text) return 'document';

  return text
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')           // spaces to hyphens
    .replace(/[^a-z0-9\-_]/g, '')   // remove special chars
    .replace(/-+/g, '-')            // collapse multiple hyphens
    .replace(/^-|-$/g, '')          // trim edge hyphens
    .substring(0, 50)               // max 50 chars
    || 'document';                  // fallback if empty after sanitization
}
```

**Examples**:
- "Pix via WhatsApp" → "pix-via-whatsapp"
- "Test@Feature#123" → "testfeature123"
- "  Multiple   Spaces  " → "multiple-spaces"
- "" → "document"
- "Very Long Title That Exceeds Fifty Characters Limit" → "very-long-title-that-exceeds-fifty-characters-l"

## Data Flow

```
User Interaction (Click Download)
  ↓
handleDownloadPdf() triggered
  ↓
Set isGeneratingPdf = true (UI shows spinner)
  ↓
html2canvas captures contentRef.current
  ↓
Canvas → toDataURL() → PNG data string
  ↓
jsPDF creates new document
  ↓
addImage() adds PNG to PDF
  ↓
save() triggers browser download
  ↓
Set isGeneratingPdf = false (UI returns to normal)
  ↓
User receives file: {documentType}_{sanitized_title}.pdf
```

## Error States

No persistent error storage. Errors are handled via:
1. Console logging (for debugging)
2. Toast notification (for user feedback)
3. State reset (`isGeneratingPdf = false`)

Error information is not stored in component state.

## No Backend Data Model

This feature does not involve:
- Database entities
- API request/response models
- Server-side storage
- Data persistence

All operations are client-side only.
