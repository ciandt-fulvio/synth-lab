# Data Model: Unified Experiment Documents

**Feature**: 026-experiment-documents
**Date**: 2025-12-31

## Entity: ExperimentDocument

Central entity for all experiment documents (summary, prfaq, executive_summary).

### Attributes

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY, pattern `doc_[a-f0-9]{8}` | Unique document identifier |
| experiment_id | TEXT | NOT NULL, FK → experiments.id | Parent experiment reference |
| document_type | TEXT | NOT NULL, ENUM | One of: summary, prfaq, executive_summary |
| markdown_content | TEXT | NOT NULL | Full document content in markdown format |
| metadata | TEXT | NULL, JSON | Type-specific metadata (chart types, synth count, etc.) |
| generated_at | TEXT | NOT NULL, ISO 8601 | Timestamp when document was generated |
| model | TEXT | DEFAULT 'gpt-4o-mini' | LLM model used for generation |
| status | TEXT | NOT NULL, DEFAULT 'completed' | Current status |
| error_message | TEXT | NULL | Error details if status is 'failed' |

### Constraints

- **UNIQUE(experiment_id, document_type)**: Only one document per type per experiment
- **FOREIGN KEY (experiment_id)**: References experiments(id) with CASCADE delete

### Status Values

| Status | Description |
|--------|-------------|
| pending | Document generation requested but not started |
| generating | Document generation in progress |
| completed | Document successfully generated |
| failed | Document generation failed (see error_message) |
| partial | Document generated with incomplete data (some insights missing) |

### Document Types

| Type | Description | Generated By |
|------|-------------|--------------|
| summary | Research interview summary | ResearchService (legacy, out of scope) |
| prfaq | PR-FAQ document | PRFAQService (legacy, out of scope) |
| executive_summary | Executive summary from analysis | ExecutiveSummaryService |

## Database Schema (SQLite)

```sql
-- Experiment Documents table (v15)
CREATE TABLE IF NOT EXISTS experiment_documents (
    id TEXT PRIMARY KEY,
    experiment_id TEXT NOT NULL,
    document_type TEXT NOT NULL,
    markdown_content TEXT NOT NULL,
    metadata TEXT CHECK(json_valid(metadata) OR metadata IS NULL),
    generated_at TEXT NOT NULL,
    model TEXT DEFAULT 'gpt-4o-mini',
    status TEXT NOT NULL DEFAULT 'completed',
    error_message TEXT,
    UNIQUE(experiment_id, document_type),
    FOREIGN KEY (experiment_id) REFERENCES experiments(id) ON DELETE CASCADE,
    CHECK(document_type IN ('summary', 'prfaq', 'executive_summary')),
    CHECK(status IN ('pending', 'generating', 'completed', 'failed', 'partial'))
);

CREATE INDEX IF NOT EXISTS idx_experiment_documents_experiment ON experiment_documents(experiment_id);
CREATE INDEX IF NOT EXISTS idx_experiment_documents_type ON experiment_documents(document_type);
CREATE INDEX IF NOT EXISTS idx_experiment_documents_status ON experiment_documents(status);
```

## Relationships

```text
experiments (1) ─────┬───── (0..3) experiment_documents
                     │
                     └── One experiment can have up to 3 documents
                         (one per document_type)
```

## Metadata Examples

### executive_summary metadata

```json
{
  "analysis_id": "ana_12345678",
  "included_chart_types": ["try_vs_success", "shap_summary", "pca_clusters"],
  "total_insights": 4,
  "completed_insights": 3,
  "generation_status": "partial",
  "model": "o1-mini"
}
```

### prfaq metadata (future)

```json
{
  "headline": "Product X revoluciona o mercado",
  "faq_count": 5,
  "research_execution_id": "exec_12345678"
}
```

### summary metadata (future)

```json
{
  "synth_count": 50,
  "successful_interviews": 48,
  "research_execution_id": "exec_12345678"
}
```

## State Transitions

```text
[none] ──start_generation()──> [generating]
                                    │
                     ┌──────────────┼──────────────┐
                     ▼              ▼              ▼
              [completed]      [partial]      [failed]
                     │              │              │
                     └──────────────┴──────────────┘
                                    │
                     ◄──regenerate()───┘
                                    │
                                    ▼
                              [generating]
```

## Validation Rules

1. **ID Format**: Must match pattern `doc_[a-f0-9]{8}`
2. **Experiment Exists**: experiment_id must reference a valid experiment
3. **Valid Type**: document_type must be one of the defined enum values
4. **Content Required**: markdown_content cannot be empty for completed status
5. **Error Required**: error_message should be set when status is 'failed'
