#!/bin/bash
#
# Git post-commit hook: Auto-atualizaÃ§Ã£o de testes e documentaÃ§Ã£o
# Detecta mudanÃ§as crÃ­ticas e oferece executar Claude Code automaticamente
#

set -e

# Cores
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Arquivos modificados no Ãºltimo commit
CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

# Flags de detecÃ§Ã£o
NEEDS_TEST_UPDATE=false
NEEDS_DOCS_UPDATE=false

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# DETECÃ‡ÃƒO DE MUDANÃ‡AS
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# MudanÃ§as que exigem atualizaÃ§Ã£o de TESTES
if echo "$CHANGED_FILES" | grep -qE "src/synth_lab/(api/routers|models/orm|services)/.*\.py"; then
    NEEDS_TEST_UPDATE=true
fi

# MudanÃ§as que exigem atualizaÃ§Ã£o de DOCS
if echo "$CHANGED_FILES" | grep -qE "src/synth_lab/(api|services|models|domain|repositories|infrastructure)/.*\.py"; then
    NEEDS_DOCS_UPDATE=true
fi

if echo "$CHANGED_FILES" | grep -qE "frontend/src/(pages|hooks|components|services)/.*\.(tsx?|jsx?)"; then
    NEEDS_DOCS_UPDATE=true
fi

# Se nenhuma mudanÃ§a crÃ­tica, sai silenciosamente
if [ "$NEEDS_TEST_UPDATE" = false ] && [ "$NEEDS_DOCS_UPDATE" = false ]; then
    exit 0
fi

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# OFERECE AUTO-UPDATE
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ¤– Auto-Update: Testes e DocumentaÃ§Ã£o${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "VocÃª modificou arquivos crÃ­ticos. Claude Code pode ajudar:"
echo ""

# Lista o que precisa atualizar
if [ "$NEEDS_TEST_UPDATE" = true ]; then
    echo -e "  ${YELLOW}ğŸ§ª TESTES${NC} - Routers/Models/Services modificados"
    echo "     â†’ Contract tests, Schema tests, Integration tests"
    echo ""
fi

if [ "$NEEDS_DOCS_UPDATE" = true ]; then
    echo -e "  ${YELLOW}ğŸ“š DOCS${NC} - Backend/Frontend modificados"
    echo "     â†’ arquitetura.md, api.md, database_model.md, arquitetura_front.md"
    echo ""
fi

echo "Executando auto-update automÃ¡tico..."
echo ""

# Sempre executa ambos com auto-commit
if [ "$NEEDS_TEST_UPDATE" = true ]; then
    echo -e "${GREEN}Executando auto-update de TESTES (auto-commit)...${NC}"
    ./scripts/auto-update-tests.sh --last-commit --auto-commit
    echo ""
fi

if [ "$NEEDS_DOCS_UPDATE" = true ]; then
    echo -e "${GREEN}Executando auto-update de DOCS (auto-commit)...${NC}"
    ./scripts/auto-update-docs.sh --last-commit --auto-commit
fi

echo ""
exit 0
