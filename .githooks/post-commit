#!/bin/bash
#
# Git post-commit hook: Sugere atualizar testes com Claude Code
# NÃ£o bloqueia - apenas oferece ajuda
#

# Verifica se mudou arquivos crÃ­ticos
CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

NEEDS_TEST_UPDATE=false

if echo "$CHANGED_FILES" | grep -q "src/synth_lab/api/routers/.*\.py"; then
    NEEDS_TEST_UPDATE=true
fi

if echo "$CHANGED_FILES" | grep -q "src/synth_lab/models/orm/.*\.py"; then
    NEEDS_TEST_UPDATE=true
fi

if echo "$CHANGED_FILES" | grep -q "src/synth_lab/services/.*service\.py"; then
    NEEDS_TEST_UPDATE=true
fi

if [ "$NEEDS_TEST_UPDATE" = true ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¤– SUGESTÃƒO: Atualizar testes automaticamente"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "VocÃª modificou arquivos crÃ­ticos (routers/models/services)."
    echo "Quer que Claude Code gere/atualize testes automaticamente?"
    echo ""
    echo "OpÃ§Ãµes:"
    echo "  1) Sim, executar agora (interativo)"
    echo "  2) Sim, executar e auto-commit"
    echo "  3) NÃ£o, farei manualmente"
    echo ""
    read -p "Escolha (1/2/3): " -n 1 -r
    echo ""

    case $REPLY in
        1)
            echo "Executando auto-update (interativo)..."
            ./scripts/auto-update-tests.sh --last-commit
            ;;
        2)
            echo "Executando auto-update (auto-commit)..."
            ./scripts/auto-update-tests.sh --last-commit --auto-commit
            ;;
        3)
            echo "OK. Para rodar depois: ./scripts/auto-update-tests.sh --last-commit"
            ;;
        *)
            echo "OpÃ§Ã£o invÃ¡lida. Pulando."
            ;;
    esac

    echo ""
fi

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# DOCUMENTAÃ‡ÃƒO
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

NEEDS_DOCS_UPDATE=false

# Detecta mudanÃ§as que afetam docs
if echo "$CHANGED_FILES" | grep -qE "src/synth_lab/(api|services|models)/"; then
    NEEDS_DOCS_UPDATE=true
fi

if echo "$CHANGED_FILES" | grep -qE "frontend/src/(pages|hooks)/"; then
    NEEDS_DOCS_UPDATE=true
fi

if [ "$NEEDS_DOCS_UPDATE" = true ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“š SUGESTÃƒO: Atualizar documentaÃ§Ã£o"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "VocÃª modificou arquivos que podem afetar a documentaÃ§Ã£o."
    echo "Quer que Claude Code atualize as docs automaticamente?"
    echo ""
    echo "OpÃ§Ãµes:"
    echo "  1) Sim, executar agora (interativo)"
    echo "  2) Sim, executar e auto-commit"
    echo "  3) NÃ£o, farei manualmente"
    echo ""
    read -p "Escolha (1/2/3): " -n 1 -r
    echo ""

    case $REPLY in
        1)
            echo "Executando auto-update docs (interativo)..."
            ./scripts/auto-update-docs.sh --last-commit
            ;;
        2)
            echo "Executando auto-update docs (auto-commit)..."
            ./scripts/auto-update-docs.sh --last-commit --auto-commit
            ;;
        3)
            echo "OK. Para rodar depois: ./scripts/auto-update-docs.sh --last-commit"
            ;;
        *)
            echo "OpÃ§Ã£o invÃ¡lida. Pulando."
            ;;
    esac

    echo ""
fi

exit 0
