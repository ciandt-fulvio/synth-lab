#!/bin/bash
#
# Git pre-push hook: Testes anti-regressÃ£o + Auto-update de docs/testes
# 1. Roda testes rÃ¡pidos (smoke + contract + schema)
# 2. Se passou, oferece atualizar docs e testes automaticamente
#

set -e

# Cores
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# FASE 1: TESTES ANTI-REGRESSÃƒO
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

echo -e "${BLUE}ğŸ§ª Running fast anti-regression tests before push...${NC}"
echo ""

if ! make test-fast; then
    echo ""
    echo -e "${RED}âŒ Pre-push tests failed!${NC}"
    echo "   Fix all failing tests before pushing."
    echo ""
    echo "   What failed:"
    echo "   - Smoke tests: Health checks (DB, configs, imports)"
    echo "   - Contract tests: API schemas that frontend expects"
    echo "   - Schema tests: DB schema vs SQLAlchemy models"
    echo ""
    echo "   To run full test suite: make test-full"
    echo "   To bypass this check (not recommended): git push --no-verify"
    echo ""
    exit 1
fi

echo ""
echo -e "${GREEN}âœ… All fast tests passed!${NC}"
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# FASE 2: DETECÃ‡ÃƒO DE MUDANÃ‡AS PARA AUTO-UPDATE
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Commits que serÃ£o enviados (comparando com remote)
REMOTE_REF=$(git rev-parse @{u} 2>/dev/null || echo "")
if [ -z "$REMOTE_REF" ]; then
    # Branch nova, compara com main/master
    REMOTE_REF=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master 2>/dev/null || echo "")
fi

if [ -z "$REMOTE_REF" ]; then
    echo "   (Full test suite will run in CI)"
    exit 0
fi

CHANGED_FILES=$(git diff --name-only "$REMOTE_REF" HEAD 2>/dev/null || echo "")

if [ -z "$CHANGED_FILES" ]; then
    echo "   (Full test suite will run in CI)"
    exit 0
fi

# Flags de detecÃ§Ã£o
NEEDS_TEST_UPDATE=false
NEEDS_DOCS_UPDATE=false

# MudanÃ§as que exigem atualizaÃ§Ã£o de TESTES
if echo "$CHANGED_FILES" | grep -qE "src/synth_lab/(api/routers|models/orm|services)/.*\.py"; then
    NEEDS_TEST_UPDATE=true
fi

# MudanÃ§as que exigem atualizaÃ§Ã£o de DOCS
if echo "$CHANGED_FILES" | grep -qE "src/synth_lab/(api|services|models|domain|repositories|infrastructure)/.*\.py"; then
    NEEDS_DOCS_UPDATE=true
fi

if echo "$CHANGED_FILES" | grep -qE "frontend/src/(pages|hooks|components|services)/.*\.(tsx?|jsx?)"; then
    NEEDS_DOCS_UPDATE=true
fi

# Se nenhuma mudanÃ§a crÃ­tica, finaliza
if [ "$NEEDS_TEST_UPDATE" = false ] && [ "$NEEDS_DOCS_UPDATE" = false ]; then
    echo "   (Full test suite will run in CI)"
    exit 0
fi

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# FASE 3: OFERECE AUTO-UPDATE
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ¤– Auto-Update: Testes e DocumentaÃ§Ã£o${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "MudanÃ§as detectadas que podem precisar de atualizaÃ§Ã£o:"
echo ""

if [ "$NEEDS_TEST_UPDATE" = true ]; then
    echo -e "  ${YELLOW}ğŸ§ª TESTES${NC} - Routers/Models/Services modificados"
fi

if [ "$NEEDS_DOCS_UPDATE" = true ]; then
    echo -e "  ${YELLOW}ğŸ“š DOCS${NC} - Backend/Frontend modificados"
fi

echo ""
echo "Deseja atualizar antes do push?"
echo "  [Y] Sim, atualizar e fazer commit"
echo "  [N] NÃ£o, continuar com push"
echo ""
read -p "Escolha [Y/N]: " -n 1 -r
echo ""

case $REPLY in
    [Yy])
        echo ""
        if [ "$NEEDS_TEST_UPDATE" = true ]; then
            echo -e "${GREEN}Executando auto-update de TESTES...${NC}"
            ./scripts/auto-update-tests.sh --last-commit --auto-commit || true
            echo ""
        fi

        if [ "$NEEDS_DOCS_UPDATE" = true ]; then
            echo -e "${GREEN}Executando auto-update de DOCS...${NC}"
            ./scripts/auto-update-docs.sh --last-commit --auto-commit || true
        fi
        echo ""
        echo -e "${GREEN}âœ… Auto-update concluÃ­do. Continuando push...${NC}"
        ;;

    *)
        echo ""
        echo "OK. Para rodar depois:"
        if [ "$NEEDS_TEST_UPDATE" = true ]; then
            echo "  ./scripts/auto-update-tests.sh"
        fi
        if [ "$NEEDS_DOCS_UPDATE" = true ]; then
            echo "  ./scripts/auto-update-docs.sh"
        fi
        echo ""
        ;;
esac

exit 0
