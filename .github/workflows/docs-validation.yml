name: Docs Validation

on:
  pull_request:
    paths:
      - 'src/**/*.py'
      - 'frontend/src/**/*.{ts,tsx}'
      - 'docs/**/*.md'
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - '.github/workflows/docs-validation.yml'
  workflow_dispatch:

jobs:
  check-docs-sync:
    name: Check if docs need update
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Precisa de 2 commits para diff

      - name: Check if docs need update
        run: |
          echo "Verificando se mudan√ßas em c√≥digo requerem atualiza√ß√£o de docs..."

          # Detecta mudan√ßas em c√≥digo que devem ter docs atualizadas
          CHANGED_CODE=$(git diff origin/main --name-only 2>/dev/null | grep -E "src/synth_lab/(api|services|models)/" || true)

          if [ -n "$CHANGED_CODE" ]; then
            echo "‚úÖ C√≥digo mudou:"
            echo "$CHANGED_CODE" | sed 's/^/  - /'

            CHANGED_DOCS=$(git diff origin/main --name-only 2>/dev/null | grep "docs/" || true)

            if [ -z "$CHANGED_DOCS" ]; then
              echo ""
              echo "::warning::‚ö†Ô∏è  C√≥digo mudou mas docs n√£o foram atualizadas"
              echo "::warning::Arquivos modificados que podem afetar docs:"
              echo "$CHANGED_CODE" | sed 's/^/::warning::  - /'
              echo "::warning::Considere rodar: ./scripts/auto-update-docs.sh"
              echo ""
              # N√£o falha, apenas avisa
            else
              echo ""
              echo "‚úÖ Docs foram atualizadas junto com c√≥digo:"
              echo "$CHANGED_DOCS" | sed 's/^/  - /'
            fi
          else
            echo "‚úÖ Nenhuma mudan√ßa em c√≥digo cr√≠tico que requer atualiza√ß√£o de docs"
          fi

  validate-markdown:
    name: Validate markdown syntax
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Validate markdown files
        run: |
          if [ -f .markdownlint.json ]; then
            echo "Usando config .markdownlint.json"
            markdownlint 'docs/**/*.md' --config .markdownlint.json || {
              echo "::error::Problemas de formata√ß√£o encontrados em arquivos markdown"
              exit 1
            }
          else
            echo "‚ö†Ô∏è  Config .markdownlint.json n√£o encontrada, usando defaults"
            markdownlint 'docs/**/*.md' || {
              echo "::error::Problemas de formata√ß√£o encontrados em arquivos markdown"
              exit 1
            }
          fi

          echo "‚úÖ Todos os arquivos markdown est√£o v√°lidos"

  check-broken-links:
    name: Check for broken internal links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check internal links
        run: |
          echo "Verificando links internos quebrados em arquivos markdown..."

          BROKEN_LINKS_FOUND=false

          # Procura por links markdown internos em docs/
          while IFS= read -r file; do
            echo "Verificando: $file"

            # Extrai links para .md files
            grep -o '\[.*\](\.\.*/.*\.md)' "$file" 2>/dev/null | while IFS= read -r link; do
              # Extrai path do link
              link_path=$(echo "$link" | sed -E 's/.*\((.*)\).*/\1/')

              # Resolve path relativo
              dir=$(dirname "$file")

              # Normaliza path (remove ../)
              full_path=$(cd "$dir" && realpath "$link_path" 2>/dev/null || echo "INVALID")

              if [ "$full_path" = "INVALID" ] || [ ! -f "$full_path" ]; then
                echo "::warning::Link quebrado em $file: $link_path"
                BROKEN_LINKS_FOUND=true
              fi
            done
          done < <(find docs -name "*.md")

          if [ "$BROKEN_LINKS_FOUND" = true ]; then
            echo "‚ö†Ô∏è  Links quebrados encontrados (veja warnings acima)"
          else
            echo "‚úÖ Nenhum link quebrado encontrado"
          fi

  check-api-docs-coverage:
    name: Check API docs coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API endpoints documentation
        run: |
          echo "üìä Verificando cobertura de documenta√ß√£o de API endpoints..."
          echo ""

          # Usa Python para extrair endpoints de forma confi√°vel
          ENDPOINTS=$(python3 -c "
          import re
          import glob

          endpoints = set()
          for file in glob.glob('src/synth_lab/api/routers/*.py'):
              with open(file) as f:
                  content = f.read()
                  # Procura por @router.METHOD('endpoint') ou @router.METHOD(\"endpoint\")
                  matches = re.findall(r'@router\.(get|post|put|delete|patch)\([\"'\'']([^\"'\'']+)', content)
                  for method, endpoint in matches:
                      endpoints.add(endpoint)

          for ep in sorted(endpoints):
              print(ep)
          " 2>/dev/null || echo "")

          if [ -z "$ENDPOINTS" ]; then
            echo "‚ö†Ô∏è  Nenhum endpoint encontrado nos routers"
            exit 0
          fi

          # Conta total
          TOTAL=$(echo "$ENDPOINTS" | wc -l | tr -d ' ')

          # Verifica quantos est√£o em docs/api.md
          DOCUMENTED=0
          NOT_DOCUMENTED=""

          while IFS= read -r endpoint; do
            if grep -q "$endpoint" docs/api.md 2>/dev/null; then
              DOCUMENTED=$((DOCUMENTED + 1))
            else
              echo "::warning::Endpoint n√£o documentado: $endpoint"
              NOT_DOCUMENTED="${NOT_DOCUMENTED}\n  - $endpoint"
            fi
          done <<< "$ENDPOINTS"

          COVERAGE=$((DOCUMENTED * 100 / TOTAL))

          echo ""
          echo "üìä API Docs Coverage: $DOCUMENTED/$TOTAL endpoints ($COVERAGE%)"
          echo ""

          if [ $COVERAGE -lt 80 ]; then
            echo "::warning::‚ö†Ô∏è  Cobertura de docs de API abaixo de 80%"
            echo "::warning::Endpoints n√£o documentados:"
            echo -e "$NOT_DOCUMENTED" | while IFS= read -r line; do
              [ -n "$line" ] && echo "::warning::$line"
            done
          else
            echo "‚úÖ Cobertura de docs de API OK (>= 80%)"
          fi
